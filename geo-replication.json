{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "prefix": {
      "type": "string",
      "defaultValue": "redisgeek",
      "minLength": 3,
      "maxLength": 11
    },
    "Region1": {
      "type": "string",
      "defaultValue": "eastus2",
      "allowedValues": [
        "australiaeast",
        "canadacentral",
        "centralindia",
        "centralus",
        "eastus",
        "eastus2",
        "northeurope",
        "southcentralus",
        "southeastasia",
        "uksouth",
        "westeurope",
        "westus2"
      ],
      "metadata": {
        "description": "Select region for geo-replication"
      }
    },
    "Region2": {
      "type": "string",
      "defaultValue": "westus2",
      "allowedValues": [
        "australiaeast",
        "canadacentral",
        "centralindia",
        "centralus",
        "eastus",
        "eastus2",
        "northeurope",
        "southcentralus",
        "southeastasia",
        "uksouth",
        "westeurope",
        "westus2"
      ],
      "metadata": {
        "description": "Select another region for geo-replication"
      }
    },
    "Plan": {
      "type": "string",
      "allowedValues": [
        "Enterprise_E10",
        "Enterprise_E20",
        "Enterprise_E50",
        "Enterprise_E100"
      ],
      "defaultValue": "Enterprise_E10",
      "metadata": {
        "description": "Select the plan"
      }
    },
    "planCapacity": {
      "type": "string",
      "allowedValues": [
        "2",
        "4",
        "6",
        "8",
        "10"
      ],
      "defaultValue": "2",
      "metadata": {
        "description": "Select the plan capacity"
      }
    },
    "evictionPolicy": {
      "type": "string",
      "allowedValues": [
        "AllKeysLFU",
        "AllKeysLRU",
        "AllKeysRandom",
        "NoEviction",
        "VolatileLFU",
        "VolatileLRU",
        "VolatileRandom",
        "VolatileTTL"
      ],
      "defaultValue": "NoEviction",
      "metadata": {
        "description": "Eviction Policy"
      }
    },
    "clientEncryption": {
      "type": "string",
      "allowedValues": [
        "Encrypted",
        "Plaintext"
      ],
      "defaultValue": "Encrypted",
      "metadata": {
        "description": "Client protocol"
      }
    },
    "clusterPolicy": {
      "type": "string",
      "allowedValues": [
        "EnterpriseCluster",
        "OSSCluster"
      ],
      "defaultValue": "EnterpriseCluster",
      "metadata": {
        "description": "Clustering policy"
      }
    }
  },
  "variables": {
    "geoReplicationGroupName": "[uniqueString(subscription().id)]",
    "acre_name_1": "[concat(parameters('prefix'), parameters('Region1'),uniqueString(subscription().id))]",
    "acre_name_2": "[concat(parameters('prefix'), parameters('Region2'),uniqueString(subscription().id))]"
  },
  "resources": [
    {
      "name": "[variables('acre_name_1')]",
      "type": "Microsoft.Cache/redisEnterprise",
      "apiVersion": "2021-02-01-preview",
      "properties": {},
      "location": "[parameters('Region1')]",
      "dependsOn": [],
      "sku": {
        "name": "[parameters('Plan')]",
        "capacity": "[parameters('planCapacity')]"
      },
      "zones": [
        "1",
        "2",
        "3"
      ],
      "tags": {},
      "resources": [
        {
          "name": "[concat(variables('acre_name_1'),'/default')]",
          "type": "Microsoft.Cache/redisEnterprise/databases",
          "apiVersion": "2021-02-01-preview",
          "properties": {
            "clientProtocol": "[parameters('clientEncryption')]",
            "evictionPolicy": "[parameters('evictionPolicy')]",
            "clusteringPolicy": "[parameters('clusterPolicy')]",
            "geoReplication": {
              "groupNickname": "[variables('geoReplicationGroupName')]",
              "linkedDatabases": [
                {
                  "id": "[concat('/subscriptions/',subscription().id,'/resourceGroups/',resourceGroup().id,'/Microsoft.Cache/redisEnterprise/',variables('acre_name_1'),'/databases/default')]"
                }
              ]
            },
            "persistence": {
              "aofEnabled": "false",
              "rdbEnabled": "false",
              "aofFrequency": "1s",
              "rdbFrequency": "1h"
            }
          },
          "dependsOn": [
            "[resourceId('Microsoft.Cache/redisEnterprise/',variables('acre_name_1'))]"
          ],
          "tags": {}
        }
      ]
    },
    {
      "name": "[variables('acre_name_2')]",
      "type": "Microsoft.Cache/redisEnterprise",
      "apiVersion": "2021-02-01-preview",
      "properties": {},
      "location": "[parameters('Region2')]",
      "dependsOn": [
        "[resourceId('Microsoft.Cache/redisEnterprise', variables('acre_name_1'))]"
      ],
      "sku": {
        "name": "[parameters('Plan')]",
        "capacity": "[parameters('planCapacity')]"
      },
      "zones": [
        "1",
        "2",
        "3"
      ],
      "tags": {},
      "resources": [
        {
          "name": "[concat(variables('acre_name_2'),'/default')]",
          "type": "Microsoft.Cache/redisEnterprise/databases",
          "apiVersion": "2021-02-01-preview",
          "properties": {
            "clientProtocol": "[parameters('clientEncryption')]",
            "evictionPolicy": "[parameters('evictionPolicy')]",
            "clusteringPolicy": "[parameters('clusterPolicy')]",
            "geoReplication": {
              "groupNickname": "[variables('geoReplicationGroupName')]",
              "linkedDatabases": [
                {
                  "id": "[concat('/subscriptions/',subscription().id,'/resourceGroups/',resourceGroup().id,'/Microsoft.Cache/redisEnterprise/',variables('acre_name_2'),'/databases/default')]"
                }
              ]
            },
            "persistence": {
              "aofEnabled": "false",
              "rdbEnabled": "false",
              "aofFrequency": "1s",
              "rdbFrequency": "1h"
            }
          },
          "dependsOn": [
            "[resourceId('Microsoft.Cache/redisEnterprise/',variables('acre_name_1'))]",
            "[resourceId('Microsoft.Cache/redisEnterprise/',variables('acre_name_2'))]"
          ],
          "tags": {}
        }
      ]
    }
  ]
}